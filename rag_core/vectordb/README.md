# Vector Database (`rag_core.vectordb`)

## 目的

埋め込みベクトルと関連メタデータの保存、および類似ベクトル検索を担当します。ベクトルデータベースとして DuckDB と VSS (Vector Similarity Search) 拡張機能を利用します。

## 実装の詳細

### `DuckDBVectorStore` クラス

`storage.py` に実装された `DuckDBVectorStore` クラスは以下の機能を提供します：

1. **初期化とセットアップ**
   - DuckDB データベースへの接続
   - VSS拡張機能のインストールとロード
   - テーブルの自動作成（存在しない場合）

2. **テーブル構造**
   ```sql
   CREATE TABLE IF NOT EXISTS {table_name} (
       id INTEGER PRIMARY KEY,  -- 自動採番ID
       text VARCHAR,           -- テキストデータ
       embedding FLOAT[1024]   -- 埋め込みベクトル（bge-m3用に1024次元）
   );
   ```

3. **主要メソッド**
   - `add_embeddings(texts: List[str], embeddings: List[np.ndarray])`: 
     - テキストと埋め込みベクトルを一括で追加
     - IDは自動的に連番が付与
   - `similarity_search(query_embedding: np.ndarray, k: int = 5)`:
     - コサイン類似度による類似ベクトル検索
     - `array_cosine_similarity` 関数を使用
     - 類似度スコアの高い順にk件を返却

## 動作確認

基本的な機能は `storage.py` を直接実行することでテストできます：

```bash
# プロジェクトルートディレクトリから実行
python3 rag_core/vectordb/storage.py
```

テストプログラムの処理フロー：

1. テスト用DBファイル `test_vector_store.db` を作成（既存の場合は削除して再作成）
2. `test_embeddings` テーブルを作成
3. サンプルテキスト3件とそのランダムな埋め込みベクトルを登録
4. ランダムなクエリベクトルで類似検索を実行（上位2件）
5. DB接続を終了

**注意:** 
- 実行後、`test_vector_store.db` ファイルがカレントディレクトリに作成されます
- このファイルは手動で削除するか、次回テスト実行時に自動的に削除されます

## 関連コンポーネント

-   `rag_core`: このパッケージの親パッケージ。
-   `rag_core.document_processor`: 処理されたドキュメントのメタデータを保存するために連携します。
-   `rag_core.embedding`: 生成された埋め込みベクトルを保存するために連携します。
-   `mcp_server`: ユーザーからのクエリに基づいて類似ベクトルを検索する際に利用されます。

## 実装知見

### 1. テーブル設計とID管理
- DuckDBではPostgreSQLの `GENERATED BY DEFAULT AS IDENTITY` や SQLiteの `AUTOINCREMENT` はサポートされていない
- `INTEGER PRIMARY KEY` で自動採番を実現する場合は、アプリケーション側でIDを管理する必要がある
- `SELECT COALESCE(MAX(id), 0)` を使用して次のIDを取得する方法が有効

### 2. VSS拡張の類似度検索
- 関数名は `list_similarity` や `vector_similarity` ではなく `array_cosine_similarity`
- パラメータ化クエリでベクトルを渡す場合、明示的な型キャスト（`?::FLOAT[1024]`）が必要
- 配列の次元数を明示的に指定する必要がある（例：`FLOAT[1024]`）

### 3. エラーハンドリング
- VSS拡張のインストール/ロード、テーブル作成、トランザクション管理など、各段階で適切なエラーハンドリングが重要
- 特に、型の不一致やVSS関数の存在確認に関するエラーは丁寧に処理する必要がある

## 関連ドキュメント

-   [ADR 001: RAG実装の技術選定](../../../docs/ADR/001-RAG実装の技術選定.md) (DuckDB+VSSの選定理由)
