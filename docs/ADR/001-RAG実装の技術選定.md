# ADR 001: RAG実装の技術選定

## 日付

2025-04-20

## コンテキスト

プロジェクト内のドキュメント検索・活用を効率化するため、Retrieval Augmented Generation (RAG) システムの構築を検討しています。これまでに調査（001〜005）を行い、ローカル環境でのRAGシステムに関する技術的な選択肢を評価してきました。

本ADRは、これらの調査結果を総括し、最終的な技術選定と実装方針を定めるものです。

## 決定事項

### 1. 開発言語

**決定**: Python言語をベースとした実装を採用します。

**代替案**:
- JavaScriptベースの実装（初期検討案）

### 2. 技術スタック

以下の技術スタックを採用します：

| コンポーネント | 選定技術 | バージョン |
|--------------|---------|----------|
| **フレームワーク** | LangChain (Python) | >=0.2.0 |
| **埋め込みモデル** | pfnet/plamo-embedding-1b | 最新版 |
| **ベクトルDB** | DuckDB + VSS拡張 | 最新版 |
| **ドキュメント処理** | LangChainローダー/スプリッター | 最新版 |
| **APIサーバー** | FastAPI | 最新版 |

**パッケージ**:
```
langchain>=0.2.0
langchain-text-splitters
langchain-community
sentence-transformers
DuckDB + VSS拡張
fastapi
uvicorn
pydantic
```

### 3. システムアーキテクチャ

基本アーキテクチャは以下の通りとします：

1. **ドキュメント処理フロー**:
   - 収集: プロジェクト内のMarkdown、PDF、テキストファイル等をロード
   - 分割: 日本語対応のテキスト分割で適切なチャンクサイズに分割
   - 埋め込み: pfnet/plamo-embedding-1bモデルによる埋め込みベクトル生成
   - 保存: DuckDB + VSS拡張への保存とインデックス化

2. **クエリ処理フロー**:
   - クエリ変換: ユーザークエリを埋め込みベクトルに変換
   - 検索: ベクトルDB内での類似度検索
   - コンテキスト生成: 検索結果からの適切なコンテキスト構築
   - 回答生成: LLMによる高品質な回答生成

3. **MCPとの連携方法**:
   - RESTful APIを介した連携

## 根拠

### Python言語の選定理由

1. **エコシステムの成熟度**: 
   - Pythonは機械学習/NLPの分野で圧倒的に広いエコシステムを持っています。
   - 埋め込み生成、ベクトル検索、自然言語処理のためのライブラリが豊富です。

2. **ライブラリの品質と充実度**:
   - 埋め込みモデルや類似検索に関する高性能ライブラリが豊富に存在します。
   - 特に日本語処理においても多くのサポートが存在します。

3. **ドキュメントとサポート**:
   - LangChainのPythonバージョンはより充実したドキュメントとコミュニティサポートを持っています。
   - トラブルシューティングや実装例が豊富に存在します。

### 技術スタックの選定理由

1. **LangChain**:
   - RAG実装に必要な機能を包括的に提供するフレームワークです。
   - ドキュメントローダー、テキスト分割、埋め込み、検索などの統合された機能を提供します。
   - 活発なコミュニティとアップデートがあります。

2. **pfnet/plamo-embedding-1b**:
   - 日本語に最適化された埋め込みモデルです。
   - ローカル環境で効率的に実行できます。
   - 高品質な埋め込みベクトルを生成します。

3. **DuckDB + VSS拡張**:
   - シンプルな導入と使用が可能なベクトルデータベースです。
   - メタデータ対応があり、検索結果の文脈情報を保持できます。
   - ローカル環境での実行が容易です。

4. **FastAPI**:
   - 高速なパフォーマンスと非同期処理に対応しています。
   - 自動ドキュメント生成機能があり、API開発の効率化が図れます。
   - Pythonベースで開発が容易です。

## 影響

### 肯定的影響

1. **実装の容易性**:
   - 既存のライブラリを活用した迅速な開発が可能です。
   - コンポーネント間の統合が容易になります。

2. **日本語処理の最適化**:
   - 日本語に強いモデルとテキスト分割機能により、プロジェクト固有の日本語ドキュメントに対する高い検索精度が期待できます。

3. **柔軟性と拡張性**:
   - さまざまなドキュメント形式や言語に対応可能です。
   - 将来的な機能拡張に対応できるアーキテクチャです。

4. **開発者の生産性向上**:
   - プロジェクト固有のドキュメントを活用したMCPの強化により、開発者の生産性が向上することが期待されます。

### 否定的影響

1. **パフォーマンス要件**:
   - 埋め込みモデルの実行には一定のリソース（メモリ、CPU）が必要となります。
   - 大量ドキュメント処理時にはリソース最適化が必要になる可能性があります。

2. **維持管理コスト**:
   - Pythonエコシステムの知識が必要となります。
   - 依存ライブラリのアップデートと互換性管理が必要です。

## リスクと対策

1. **パフォーマンスリスク**:
   - **リスク**: 大量データ処理時のメモリ使用量増大やレスポンス時間の遅延
   - **対策**: バッチ処理の導入、キャッシュ機構の実装、埋め込みモデルの量子化や最適化

2. **セキュリティリスク**:
   - **リスク**: クエリインジェクション、機密情報漏洩
   - **対策**: 入力検証の徹底、認証機構の実装、センシティブ情報検出の導入

3. **統合リスク**:
   - **リスク**: MCPとの連携における互換性問題
   - **対策**: 早期の統合テスト、明確なAPI仕様の策定、段階的な導入

### ハードウェア要件

- **開発環境**: 16GB以上のRAMを搭載したローカルマシン（理想的には32GB）
- **本番環境**: 16GBのRAM、4vCPU以上のサーバー
- **ストレージ**: プロジェクトドキュメントとベクトルインデックス用に最低20GB

## 注釈

- 本ADRは、`/docs/調査/005-RAG実装調査レポート：要約と推奨.md`および関連する調査ドキュメントに基づいて作成されました。
- 実装の詳細については、今後作成される機能仕様書を参照してください。

## 参考資料

1. [LangChain公式ドキュメント](https://python.langchain.com/docs/)
2. [pfnet/plamo-embedding-1b公式ドキュメント](https://www.sbert.net/)
3. [FastAPI公式ドキュメント](https://fastapi.tiangolo.com/)
4. [Hugging Face Embeddings](https://huggingface.co/models?sort=downloads&search=embeddings)
